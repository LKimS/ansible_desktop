---
- hosts: localhost
  connection: local
  become: true

  tasks:
    - name: add ansible user
      user:
        name: velociraptor
        system: yes

    - name: set up sudo for ansible user
      copy:
        src: files/sudoer_velociraptor
        dest: /etc/sudoers.d/velociraptor
        owner: root
        group: root
        mode: 0440

    - name: Install Zsh
      apt:
        name: zsh
        state: present

    - name: change user shell to zsh 
      user:
        name: lkims
        shell: /bin/zsh

 # New tasks for Homebrew installation
    - name: Install Homebrew dependencies
      apt:
        name:
          - build-essential
          - procps
          - curl
          - file
          - git
        state: present

    - name: Download Homebrew installation script
      get_url:
        url: https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh
        dest: /tmp/homebrew_install.sh
        mode: '0755'
      become: false
      become_user: lkims

    - name: Install Homebrew
      become: true
      become_user: lkims
      shell: |
        /bin/bash /tmp/homebrew_install.sh

      args:
        creates: /home/linuxbrew/.linuxbrew/bin/brew

    - name: Add Homebrew to PATH
      lineinfile:
        path: /home/lkims/.zshrc
        line: 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"'
        state: present
      become: false
      become_user: lkims

    - name: Cleanup Homebrew installation script
      file:
        path: /tmp/homebrew_install.sh
        state: absent
      become: false
          
    - name: Install GCC using Homebrew
      command: /home/linuxbrew/.linuxbrew/bin/brew install gcc
      become: true
      become_user: lkims

    - name: Install htop using Homebrew
      homebrew:
        name: 
          - htop
          - ripgrep
          - tlrc
          - bat
        state: present
      become: true
      become_user: lkims
      environment:
        PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
        HOME: "/home/lkims"

    - name: Install p10k using Homebrew
      homebrew:
        name: 
          - powerlevel10k
        state: present
      become: true
      become_user: lkims
      environment:
        PATH: "/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}"
        HOME: "/home/lkims"

    - name: Add p10k to PATH
      lineinfile:
        path: /home/lkims/.zshrc
        line: 'source /usr/share/zsh-theme-powerlevel10k/powerlevel10k.zsh-theme'
        state: present
      become: false
      become_user: lkims
  
